networks:
  loki:

services:
  # =========================================
  # 1. APLIKASI UTAMA (SEASNACKY) 
  # =========================================
  seasnacky:
    build: 
      context: ..
      dockerfile: Dockerfile
    container_name: seasnacky_app
    ports:
      - "3000:3000"
    restart: always
    environment:
      # ðŸ‘‡ INI KUNCI ASLINYA (Dicopy dari data kamu) ðŸ‘‡
      
      # Database (Penting)
      - MONGODB_URI=mongodb+srv://disyaauliashafa_db:seasnacky123@cluster0.sy5zadd.mongodb.net/seasnacky?retryWrites=true&w=majority&appName=Cluster0
      - DATABASE_URL=mongodb+srv://disyaauliashafa_db:seasnacky123@cluster0.sy5zadd.mongodb.net/seasnacky?retryWrites=true&w=majority&appName=Cluster0
      
      # Keamanan
      - JWT_SECRET=change-me-super-secret
      
      # Cloudinary (Server)
      - CLOUDINARY_CLOUD_NAME=ddmtevdyv
      - CLOUDINARY_API_KEY=378284672364331
      - CLOUDINARY_API_SECRET=aY7coo9IVfcoCIKglEbj9qlVtKw
      - CLOUDINARY_UPLOAD_FOLDER=seasnacky
      
      # Cloudinary (Client/Public)
      - NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME=ddmtevdyv
      - NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET=seasnacky
      
      # Config Lain
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://localhost:3000
      - LOKI_HOST=http://loki:3100
    
    networks:
      - loki
    depends_on:
      - loki

  # =========================================
  # 2. MONITORING STACK (LOKI & GRAFANA)
  # =========================================
  loki:
    image: grafana/loki:2.9.0
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki/loki-config.yaml:/etc/loki/local-config.yaml
    networks:
      - loki

  promtail:
    image: grafana/promtail:2.9.0
    volumes:
      - /var/log:/var/log
      - ./promtail/promtail-config.yaml:/etc/promtail/config.yaml
    command: -config.file=/etc/promtail/config.yaml
    networks:
      - loki

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000" # Grafana jalan di port 3001
    environment:
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    entrypoint:
      - sh
      - -euc
      - |
        mkdir -p /etc/grafana/provisioning/datasources
        cat <<EOF > /etc/grafana/provisioning/datasources/ds.yaml
        apiVersion: 1
        datasources:
        - name: Loki
          type: loki
          access: proxy
          orgId: 1
          url: http://loki:3100
          basicAuth: false
          isDefault: true
          version: 1
          editable: false
        EOF
        /run.sh
    networks:
      - loki